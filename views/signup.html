<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sindhudurg Pet Care - Signup</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/login.css">
  <style>
    :root {
      --primary-color: #2c7873;
      --secondary-color: #6ab187;
      --accent-color: #f0a500;
    }
    .otp-container { display: none; }
    .otp-input-group { display: flex; gap: 10px; justify-content: center; margin: 15px 0; }
    .otp-input {
      width: 50px; height: 50px; text-align: center; font-size: 1.2rem;
      border: 2px solid #e0e0e0; border-radius: 8px;
    }
    .otp-input:focus { border-color: var(--primary-color); box-shadow: 0 0 5px rgba(44, 120, 115, 0.3); }
    .timer { text-align: center; color: #666; font-size: 0.9rem; margin: 10px 0; }
    .resend-otp { text-align: center; margin: 15px 0; }
    .resend-otp a { color: var(--primary-color); text-decoration: none; }
    .resend-otp a:hover { text-decoration: underline; }
    .verification-success {
      background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724;
      padding: 10px; border-radius: 5px; text-align: center; margin: 10px 0; display: none;
    }
    .btn-verify { background: var(--secondary-color); color: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: 600; }
    .btn-verify:hover { background: #5da57a; }
    .mobile-verification-status { display: flex; align-items: center; gap: 8px; margin-top: 5px; font-size: 0.9rem; }
    .status-verified { color: var(--secondary-color); }
    .status-pending { color: var(--accent-color); }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-card fade-in" id="signupForm">
      <div class="row g-0">
        <!-- Left -->
        <div class="col-lg-6 login-left">
          <div class="logo"><i class="fas fa-paw"></i>Sindhudurg Pet Care</div>
          <h1 class="welcome-title">Create Account</h1>
          <p>Join the Sindhudurg Pet Care Management System to help ensure the wellbeing of animals across our district.</p>
          <ul>
            <li><i class="fas fa-check-circle"></i> Easy pet registration</li>
            <li><i class="fas fa-check-circle"></i> Veterinary services</li>
            <li><i class="fas fa-check-circle"></i> Health monitoring</li>
            <li><i class="fas fa-check-circle"></i> Checkup reminders</li>
          </ul>
          <a href="/login" class="btn btn-signup">Already have an account? Sign In</a>
        </div>

        <!-- Right -->
        <div class="col-lg-6 login-right">
          <h2 class="login-title">Sign Up</h2>
          <form id="signupFormElement">
            <div class="form-group">
              <label>Full Name</label>
              <input placeholder="Enter Your Full Name" type="text" id="signupUsername" class="form-control" required>
            </div>

            <div class="form-group">
              <label>Mobile Number</label>
              <div class="input-group">
                <span class="input-group-text">+91</span>
                <input placeholder="Enter Your Mobile Number" type="tel" id="mobileNumber" class="form-control" maxlength="10" required>
                <button type="button" class="btn btn-verify" id="sendOtpBtn">Send OTP</button>
              </div>
              <div id="mobileStatus" class="mobile-verification-status">
                <i class="fas fa-circle status-pending"></i>
                <span>Mobile number not verified</span>
              </div>
            </div>

            <!-- OTP Section -->
            <div class="otp-container" id="otpContainer">
              <div class="otp-input-group">
                <input type="text" maxlength="1" class="otp-input" data-index="1">
                <input type="text" maxlength="1" class="otp-input" data-index="2">
                <input type="text" maxlength="1" class="otp-input" data-index="3">
                <input type="text" maxlength="1" class="otp-input" data-index="4">
                <input type="text" maxlength="1" class="otp-input" data-index="5">
                <input type="text" maxlength="1" class="otp-input" data-index="6">
              </div>
              <div class="timer" id="timer">02:00</div>
              <div class="resend-otp"><a href="#" id="resendOtp">Resend OTP</a></div>
              <button type="button" class="btn btn-login w-100" id="verifyOtpBtn">Verify OTP</button>
              <div class="verification-success" id="verificationSuccess">
                <i class="fas fa-check-circle"></i> Mobile verified successfully!
              </div>
            </div>

            <div class="form-group">
              <label>Password</label>
              <input type="password" id="signupPassword" class="form-control" required>
            </div>
            <div class="form-group">
              <label>Confirm Password</label>
              <input type="password" id="confirmPassword" class="form-control" required>
            </div>

            <div class="form-group">
              <label>District</label>
              <select id="district" class="form-control" required>
                <option value="">Select District</option>
              </select>
            </div>
            <div class="form-group">
              <label>Taluka</label>
              <select id="taluka" class="form-control" required>
                <option value="">Select Taluka</option>
              </select>
            </div>
            <div class="form-group">
              <label>Village</label>
              <select id="village" class="form-control" required>
                <option value="">Select Village</option>
              </select>
            </div>

            <div class="form-group form-check">
              <input type="checkbox" class="form-check-input" id="agreeTerms" required>
              <label class="form-check-label">I agree to the <a href="#">Terms</a> & <a href="#">Privacy Policy</a></label>
            </div>

            <button type="submit" class="btn btn-login w-100">Create Account</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const sendOtpBtn = document.getElementById("sendOtpBtn");
    const verifyOtpBtn = document.getElementById("verifyOtpBtn");
    const resendOtpLink = document.getElementById("resendOtp");
    const otpContainer = document.getElementById("otpContainer");
    const mobileInput = document.getElementById("mobileNumber");
    const mobileStatus = document.getElementById("mobileStatus");
    const signupForm = document.getElementById("signupFormElement");

    let verified = false;
    let timerInterval;

    // âœ… Send OTP
    sendOtpBtn.addEventListener("click", async () => {
      const mobile = mobileInput.value.trim();
      if (mobile.length !== 10) return alert("Enter valid 10-digit mobile number");

      const res = await fetch("/signup/send-otp", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mobileNumber: mobile }),
      });
      const data = await res.json();
      if (data.success) {
        otpContainer.style.display = "block";
        startTimer(120);
        alert("OTP sent successfully!");
      } else alert(data.message);
    });

    // ðŸ” Resend OTP
    resendOtpLink.addEventListener("click", async (e) => {
      e.preventDefault();
      const mobile = mobileInput.value.trim();
      const res = await fetch("/signup/resend-otp", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mobileNumber: mobile }),
      });
      const data = await res.json();
      if (data.success) {
        alert("OTP resent successfully!");
        startTimer(120);
      } else alert(data.message);
    });

    // âœ… Verify OTP
    verifyOtpBtn.addEventListener("click", async () => {
      const otp = Array.from(document.querySelectorAll(".otp-input")).map(i => i.value).join("");
      const mobile = mobileInput.value.trim();
      const res = await fetch("/signup/verify-otp", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mobileNumber: mobile, otp }),
      });
      const data = await res.json();
      if (data.success) {
        verified = true;
        document.getElementById("verificationSuccess").style.display = "block";
        mobileStatus.innerHTML = '<i class="fas fa-check-circle status-verified"></i> <span>Verified</span>';
      } else alert(data.message);
    });

    // â± Timer
    function startTimer(duration) {
      let time = duration;
      clearInterval(timerInterval);
      const timerEl = document.getElementById("timer");
      timerInterval = setInterval(() => {
        const min = String(Math.floor(time / 60)).padStart(2, "0");
        const sec = String(time % 60).padStart(2, "0");
        timerEl.textContent = `${min}:${sec}`;
        if (--time < 0) clearInterval(timerInterval);
      }, 1000);
    }

    // ðŸ§¾ District-Taluka-Village fetch
    async function loadDistricts() {
      const res = await fetch("/signup/districts");
      const data = await res.json();
      if (data.success) {
        const districtSelect = document.getElementById("district");
        districtSelect.innerHTML = "<option value=''>Select District</option>";
        data.districts.forEach(d => {
          const opt = document.createElement("option");
          opt.value = d.id; opt.textContent = d.name;
          districtSelect.appendChild(opt);
        });
      }
    }

    document.getElementById("district").addEventListener("change", async e => {
      const res = await fetch(`/signup/talukas/${e.target.value}`);
      const data = await res.json();
      const talukaSelect = document.getElementById("taluka");
      talukaSelect.innerHTML = "<option value=''>Select Taluka</option>";
      data.talukas.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id; opt.textContent = t.name;
        talukaSelect.appendChild(opt);
      });
    });

    document.getElementById("taluka").addEventListener("change", async e => {
      const res = await fetch(`/signup/villages/${e.target.value}`);
      const data = await res.json();
      const villageSelect = document.getElementById("village");
      villageSelect.innerHTML = "<option value=''>Select Village</option>";
      data.villages.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.id; opt.textContent = v.name;
        villageSelect.appendChild(opt);
      });
    });

    // ðŸ§¾ Form submit
    signupForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!verified) return alert("Please verify your mobile number first!");

      const payload = {
        fullName: document.getElementById("signupUsername").value,
        mobileNumber: mobileInput.value,
        password: document.getElementById("signupPassword").value,
        confirmPassword: document.getElementById("confirmPassword").value,
        taluka: document.getElementById("taluka").selectedOptions[0].text,
        village: document.getElementById("village").selectedOptions[0].text,
        userType: "patient",
        agreeToTerms: document.getElementById("agreeTerms").checked,
      };

      const res = await fetch("/signup/create", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (data.success) {
        alert(`Signup successful! Your user code: ${data.userCode}`);
        window.location.href = "/login";
      } else alert(data.message);
    });

    loadDistricts();
  });
  // ðŸ”¢ OTP Input Auto-Move Logic
const otpInputs = document.querySelectorAll(".otp-input");

otpInputs.forEach((input, index) => {
  input.addEventListener("input", (e) => {
    const value = e.target.value;
    // Only allow digits
    if (!/^[0-9]$/.test(value)) {
      e.target.value = "";
      return;
    }

    // Move to next input if one digit is entered
    if (value && index < otpInputs.length - 1) {
      otpInputs[index + 1].focus();
    }
  });

  input.addEventListener("keydown", (e) => {
    // Handle backspace â†’ move to previous box if empty
    if (e.key === "Backspace" && !e.target.value && index > 0) {
      otpInputs[index - 1].focus();
    }
  });

  // Allow paste (e.g., if user copies the OTP)
  input.addEventListener("paste", (e) => {
    e.preventDefault();
    const pasteData = e.clipboardData.getData("text").slice(0, otpInputs.length);
    otpInputs.forEach((inp, i) => {
      inp.value = pasteData[i] || "";
    });
    // Move to last filled input
    const nextEmpty = Array.from(otpInputs).findIndex(i => i.value === "");
    if (nextEmpty !== -1) otpInputs[nextEmpty].focus();
    else otpInputs[otpInputs.length - 1].focus();
  });
});

  </script>
</body>
</html>
